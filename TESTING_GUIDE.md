# Testing Guide - Phase 3 Features

This guide will help you test the newly implemented Phase 3 features: Setup Wizard, Diagnostics Tool, and Reschedule Flow.

## Prerequisites

1. **Node.js** (v18.20+, v20.10+, or v21+)
2. **PostgreSQL** database running
3. **Shopify Partner Account** with a development store
4. **Shopify CLI** installed

## Setup Instructions

### 1. Install Dependencies

```bash
npm install
```

### 2. Configure Environment

Copy the example environment file:

```bash
cp .env.example .env
```

Edit `.env` and configure:

```env
# Get these from your Shopify Partner Dashboard
SHOPIFY_API_KEY=your_api_key_here
SHOPIFY_API_SECRET=your_api_secret_here

# Database connection (make sure PostgreSQL is running)
DATABASE_URL=postgresql://username:password@localhost:5432/ordakgov2

# Will be auto-generated by Shopify CLI
SHOPIFY_APP_URL=https://your-tunnel-url.ngrok.io

# Generate a random secret
SESSION_SECRET=your_random_session_secret_here
```

### 3. Setup Database

Run Prisma migrations:

```bash
npm run prisma migrate deploy
npm run prisma generate
```

### 4. Configure Shopify App

Link your app to your Shopify Partner app:

```bash
npm run config:link
```

Follow the prompts to connect to your Shopify Partner app.

### 5. Start Development Server

```bash
npm run dev
```

This will:
- Start the Remix development server
- Create a tunnel URL (using ngrok or Cloudflare)
- Open your browser to install the app on your dev store

## Testing Phase 3 Features

### Test 1: Setup Wizard

**Route:** `/app/setup`

**Test Steps:**

1. **Access the Setup Wizard**
   - After installing the app, navigate to `/app/setup` or click "Run Setup Wizard" from the dashboard
   - Verify the welcome screen appears with progress bar at 0%

2. **Step 1: Shop Settings**
   - Toggle "Enable Smart Recommendations"
   - Adjust the four weight sliders:
     - Capacity Weight: 80
     - Distance Weight: 60
     - Route Efficiency Weight: 70
     - Personalization Weight: 50
   - Click "Continue"
   - Verify progress bar updates to ~17%

3. **Step 2: Create First Location**
   - Fill in location details:
     - Name: "Main Warehouse"
     - Address: "123 Test Street, London"
     - Postcode: "SW1A 1AA"
     - Timezone: "Europe/London"
     - Check "Supports Delivery"
     - Check "Supports Pickup"
   - Optional: Add coordinates (51.5074, -0.1278)
   - Click "Continue"
   - Verify progress bar updates to ~33%

4. **Step 3: Create First Zone**
   - Name: "Central London"
   - Zone Type: "Postcode Range"
   - Postcode Start: "SW1A"
   - Postcode End: "SW1Z"
   - Click "Continue"
   - Verify progress bar updates to ~50%

5. **Step 4: Configure Rules**
   - Enable "Order Cutoff Time"
     - Set cutoff time: 12:00
     - Days before delivery: 1
   - Enable "Minimum Lead Time"
     - Minimum lead time: 2 days
   - Click "Complete Setup"
   - Verify progress bar reaches 100%

6. **Step 5: Completion**
   - Verify success message appears
   - Verify all completed steps are listed
   - Click "Go to Dashboard"
   - Verify dashboard shows setup complete status

**Expected Results:**
‚úÖ All data saved to database
‚úÖ Shop settings updated with recommendation weights
‚úÖ Location created with correct details
‚úÖ Zone created and linked to location
‚úÖ Two rules created (cutoff and lead time)

---

### Test 2: Diagnostics Tool

**Route:** `/app/diagnostics`

**Prerequisites:**
- Complete Test 1 (Setup Wizard)
- Create at least one slot manually via `/app/locations` ‚Üí View Location ‚Üí Add Slots

**Test Steps:**

1. **Access Diagnostics Tool**
   - Navigate to `/app/diagnostics` or click "Run Diagnostics" from dashboard
   - Verify the diagnostic form appears

2. **Test Scenario 1: No Data (Fresh Install)**
   - Leave postcode empty
   - Fulfillment Type: "Delivery"
   - Date From: Tomorrow
   - Date To: 14 days from now
   - Click "Run Diagnostics"

   **Expected Results:**
   - ‚ùå Slots Created: FAIL - No slots found
   - ‚úÖ Locations Configured: PASS - 1 location supports delivery
   - ‚úÖ Zones Configured: PASS - 1 zone configured
   - ‚ö†Ô∏è Postcode Coverage: WARNING - No postcode provided
   - ‚ö†Ô∏è Available Capacity: WARNING - No slots to check
   - ‚úÖ Business Rules: PASS - 2 active rules
   - ‚ö†Ô∏è Date Range Coverage: WARNING - No slots in range

3. **Test Scenario 2: Check Postcode Coverage**
   - Postcode: "SW1A 1AA"
   - Fulfillment Type: "Delivery"
   - Keep same date range
   - Click "Run Diagnostics"

   **Expected Results:**
   - ‚úÖ Postcode Coverage: PASS - Postcode is covered by zone
   - Shows "Central London" zone name

4. **Test Scenario 3: Invalid Postcode**
   - Postcode: "EC1A 1BB" (outside your zone)
   - Click "Run Diagnostics"

   **Expected Results:**
   - ‚ùå Postcode Coverage: FAIL - Postcode not covered
   - Shows action: "Create or modify zones to include this postcode"

5. **Test Scenario 4: With Slots Created**
   - First, create some slots:
     - Go to `/app/locations`
     - Click on "Main Warehouse"
     - Create 5 slots for tomorrow with capacity 10
   - Run diagnostics again with postcode "SW1A 1AA"

   **Expected Results:**
   - ‚úÖ Slots Created: PASS - 5 slots found
   - ‚úÖ Available Capacity: PASS - 5 slots have capacity
   - ‚úÖ Date Range Coverage: PASS

6. **Test Scenario 5: Fully Booked Slots**
   - Manually update slot `booked` count to equal `capacity` in database
   - Run diagnostics

   **Expected Results:**
   - ‚ö†Ô∏è Available Capacity: WARNING - All slots fully booked

**Quick Stats to Verify:**
- Total Slots: Should match created slots
- Available: Slots with booked < capacity
- Fully Booked: Slots with booked >= capacity
- Locations, Zones, Rules: Should match your setup

---

### Test 3: Reschedule Flow

**Route:** `/app/orders`

**Prerequisites:**
- Complete Test 1 & 2
- Have at least 2 slots created for different dates
- Have at least 1 order booking in the database

**Setup Test Data:**

```sql
-- Create a test order booking (run in your PostgreSQL client)
INSERT INTO "OrderLink" (
  id,
  "shopId",
  "slotId",
  "shopifyOrderId",
  status,
  "fulfillmentType",
  "deliveryAddress",
  "deliveryPostcode",
  "createdAt",
  "updatedAt"
)
VALUES (
  gen_random_uuid(),
  (SELECT id FROM "Shop" LIMIT 1),
  (SELECT id FROM "Slot" ORDER BY date ASC LIMIT 1),
  'TEST-1001',
  'scheduled',
  'delivery',
  '123 Test Street, London',
  'SW1A 1AA',
  NOW(),
  NOW()
);

-- Update the slot's booked count
UPDATE "Slot"
SET booked = booked + 1
WHERE id = (SELECT id FROM "Slot" ORDER BY date ASC LIMIT 1);
```

**Test Steps:**

1. **View Orders List**
   - Navigate to `/app/orders`
   - Verify orders table displays with columns:
     - Order ID, Status, Type, Postcode, Slot Date, Slot Time, Location, Booked On, Actions
   - Verify test order "TEST-1001" appears
   - Verify status badge shows "Scheduled" in green

2. **Filter Orders**
   - Search: Enter "TEST-1001" in search box
   - Click "Apply Filters"
   - Verify only matching order appears
   - Clear search
   - Status Filter: Select "Scheduled"
   - Click "Apply Filters"
   - Verify only scheduled orders appear

3. **Access Reschedule Interface**
   - Click "Reschedule" button on TEST-1001
   - Verify redirects to `/app/orders/TEST-1001/reschedule`
   - Verify current booking details displayed:
     - Order ID
     - Status badge
     - Fulfillment type
     - Address and postcode
     - Current slot date/time
     - Location name and address

4. **Browse Available Slots**
   - Verify "Available Alternative Slots" table displays
   - Verify current slot shows "Current" badge and no select button
   - Verify other slots show "Select" button
   - Verify slots show:
     - Date, Time, Location, Capacity (available/total), Score, Action button

5. **Reschedule Order**
   - Click "Select" on a different slot
   - Verify slot is highlighted/selected
   - Verify "Reschedule to Selected Slot" form appears
   - Enter reason: "Customer requested different date"
   - Click "Confirm Reschedule"
   - Verify success banner appears
   - Verify order link updated in database
   - Verify old slot's `booked` count decremented
   - Verify new slot's `booked` count incremented

6. **Check Event History**
   - Scroll to "Event History" section
   - Verify event log entry appears:
     - Badge: "order.schedule_updated" (blue/info)
     - Timestamp
     - Reason: "Customer requested different date"
     - Shows old and new slot details

7. **Test Cancel Booking**
   - Click "Cancel This Booking" button
   - Verify modal appears with warning message
   - Enter cancellation reason: "Customer requested cancellation"
   - Click "Cancel Booking"
   - Verify order status changed to "canceled"
   - Verify slot's `booked` count decremented
   - Verify event log entry created: "order.schedule_canceled"

8. **Test Validation**
   - Try to reschedule a canceled order
   - Verify "Reschedule" button is disabled
   - Try to select a fully booked slot
   - Verify error message appears

**Database Verification:**

After testing, check the database:

```sql
-- Verify order status updated
SELECT "shopifyOrderId", status, "slotId" FROM "OrderLink" WHERE "shopifyOrderId" = 'TEST-1001';

-- Verify event logs created
SELECT "eventType", timestamp FROM "EventLog"
WHERE "orderLinkId" = (SELECT id FROM "OrderLink" WHERE "shopifyOrderId" = 'TEST-1001')
ORDER BY timestamp DESC;

-- Verify slot booked counts are correct
SELECT id, date, "timeStart", capacity, booked FROM "Slot";
```

---

### Test 4: API Reschedule Endpoint

**Route:** `POST /api/reschedule`

**Test with cURL or Postman:**

```bash
curl -X POST http://localhost:3000/api/reschedule \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "shop=your-shop.myshopify.com" \
  -d "orderId=TEST-1001" \
  -d "newSlotId=<slot-uuid>" \
  -d "reason=Customer changed mind"
```

**Expected Response (Success):**

```json
{
  "success": true,
  "message": "Order successfully rescheduled",
  "data": {
    "orderId": "TEST-1001",
    "newSlot": {
      "id": "uuid-here",
      "date": "2025-11-10T00:00:00.000Z",
      "timeStart": "09:00",
      "timeEnd": "12:00",
      "location": {
        "name": "Main Warehouse",
        "address": "123 Test Street, London"
      }
    }
  }
}
```

**Expected Response (Error - Slot Full):**

```json
{
  "success": false,
  "error": "Selected slot is fully booked"
}
```

---

### Test 5: Dashboard Integration

**Route:** `/app`

**Test Steps:**

1. **Verify Quick Stats**
   - Navigate to dashboard
   - Verify stats show:
     - Locations: 1
     - Zones: 1
     - Active Rules: 2
     - Total Bookings: (your count)

2. **Test Setup Status Banner**
   - If setup incomplete: Verify warning banner appears
   - If setup complete: Verify no warning banner
   - Click "Run Setup Wizard" button
   - Verify navigates to `/app/setup`

3. **Test Management Tools Cards**
   - Verify 3 cards appear: Orders, Diagnostics, Setup Wizard
   - Click each button and verify navigation:
     - "View Orders" ‚Üí `/app/orders`
     - "Run Diagnostics" ‚Üí `/app/diagnostics`
     - "Run Setup" ‚Üí `/app/setup`

4. **Test Configuration Cards**
   - Verify 3 cards: Locations, Zones, Recommendations
   - Test each button:
     - Locations "View All" ‚Üí `/app/locations`
     - Locations "Add New" ‚Üí `/app/locations/new`
     - Zones "View All" ‚Üí `/app/zones`
     - Zones "Add New" ‚Üí `/app/zones/new`
     - Recommendations "Configure" ‚Üí `/app/settings/recommendations`

---

## Common Issues & Troubleshooting

### Issue: "Shop not found" error
**Solution:** Make sure you've installed the app on your Shopify dev store and authenticated properly.

### Issue: Database connection errors
**Solution:**
- Verify PostgreSQL is running: `pg_isready`
- Check DATABASE_URL in .env
- Run migrations: `npm run prisma migrate deploy`

### Issue: No slots appearing in diagnostics
**Solution:** Create slots manually:
1. Go to `/app/locations`
2. Click on a location
3. Use the slot creation interface (if available)
4. Or insert test slots via SQL

### Issue: Can't access reschedule page
**Solution:** Make sure you have OrderLink records in the database. Use the SQL insert statement provided above.

### Issue: Styling looks broken
**Solution:**
- Clear browser cache
- Verify Polaris CSS is loading
- Check browser console for errors

---

## Test Checklist

Use this checklist to ensure all features are working:

### Setup Wizard
- [ ] Welcome screen loads
- [ ] Progress bar updates correctly
- [ ] Shop settings save
- [ ] Location created successfully
- [ ] Zone created and linked to location
- [ ] Business rules created
- [ ] Completion screen shows
- [ ] Can navigate back to dashboard

### Diagnostics Tool
- [ ] Diagnostic form displays
- [ ] Can run diagnostics without postcode
- [ ] Can test with valid postcode
- [ ] Can test with invalid postcode
- [ ] All 7 checks display with correct status
- [ ] Action recommendations appear for failures
- [ ] Quick summary shows correct counts
- [ ] Troubleshooting guide displays

### Reschedule Flow
- [ ] Orders list displays with pagination
- [ ] Can search by order ID
- [ ] Can filter by status
- [ ] Reschedule page loads correctly
- [ ] Current booking details display
- [ ] Available slots table displays
- [ ] Can select alternative slot
- [ ] Can reschedule with reason
- [ ] Event history displays
- [ ] Can cancel booking
- [ ] Validation prevents invalid actions
- [ ] Database updates correctly

### Dashboard
- [ ] Quick stats display correctly
- [ ] Setup banner appears when incomplete
- [ ] All navigation buttons work
- [ ] Can access all Phase 3 features from dashboard

### API
- [ ] Reschedule API endpoint responds
- [ ] Returns success for valid requests
- [ ] Returns errors for invalid requests
- [ ] Updates database correctly
- [ ] Creates event log entries

---

## Performance Testing

Test with larger datasets:

1. **Create 100+ slots** across multiple dates
2. **Create 50+ order bookings**
3. **Test pagination** in orders list
4. **Test diagnostics** with many slots
5. **Verify response times** are acceptable

---

## Browser Compatibility

Test in multiple browsers:
- [ ] Chrome/Edge
- [ ] Firefox
- [ ] Safari

---

## Next Steps

After testing, consider:

1. **Integration Testing** - Test with real Shopify orders
2. **End-to-End Testing** - Test complete customer journey
3. **Load Testing** - Test with concurrent users
4. **Security Testing** - Verify authentication and authorization
5. **Accessibility Testing** - Ensure WCAG compliance

---

## Reporting Issues

If you find bugs or issues:

1. Note the exact steps to reproduce
2. Include browser console errors
3. Provide screenshots if UI issue
4. Check database state
5. Report via GitHub Issues

---

**Happy Testing! üéâ**
